name: Run Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    name: test
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.10']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Check for tests directory
        id: check_tests
        run: |
          if [ -d "tests" ] && [ "$(find tests -name 'test_*.py' -type f 2>/dev/null | wc -l)" -gt 0 ]; then
            echo "tests_exist=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Tests directory found with test files"
          else
            echo "tests_exist=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  No tests directory or test files found"
            echo "This is expected for initial setup. Tests will be added in future syncs."
          fi
      
      - name: Install dependencies
        if: steps.check_tests.outputs.tests_exist == 'true'
        run: |
          python3 -m pip install --upgrade pip
          pip install pytest pytest-cov
      
      - name: Install project dependencies
        if: steps.check_tests.outputs.tests_exist == 'true'
        run: |
          echo "[DEBUG] Installing project dependencies..."
          if [ -f "requirements.txt" ]; then
            echo "[DEBUG] Installing core requirements..."
            pip install -r requirements.txt
          fi
          if [ -f "requirements-dev.txt" ]; then
            echo "[DEBUG] Installing dev requirements..."
            pip install -r requirements-dev.txt
          fi
          # Install capture deps with system requirements (optional)
          if [ -f "requirements-capture.txt" ]; then
            echo "[DEBUG] Installing capture requirements (with system deps)..."
            sudo apt-get update
            sudo apt-get install -y gcc libpcap-dev
            pip install -r requirements-capture.txt
          fi
          echo "[DEBUG] Dependencies installed successfully"
      
      - name: Run tests
        if: steps.check_tests.outputs.tests_exist == 'true'
        run: |
          echo "üß™ Running test suite..."
          # Determine coverage target based on what exists
          if [ -d "src/community" ]; then
            pytest tests/ -v --cov=src/community --cov-report=term-missing --cov-report=xml || pytest tests/ -v
          elif [ -d "scripts/generate_community_docs" ]; then
            pytest tests/ -v --cov=scripts/generate_community_docs --cov-report=term-missing --cov-report=xml || pytest tests/ -v
          else
            pytest tests/ -v
          fi
      
      - name: Upload coverage reports
        if: steps.check_tests.outputs.tests_exist == 'true' && matrix.python-version == '3.10'
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
      
      - name: Check test coverage
        if: steps.check_tests.outputs.tests_exist == 'true'
        run: |
          echo "üìä Coverage report:"
          if [ -d "src/community" ]; then
            pytest tests/ --cov=src/community --cov-report=term --cov-report=term-missing || true
          elif [ -d "scripts/generate_community_docs" ]; then
            pytest tests/ --cov=scripts/generate_community_docs --cov-report=term --cov-report=term-missing || true
          fi
          echo ""
          echo "Target: >90% coverage"
      
      - name: Skip tests (no tests found)
        if: steps.check_tests.outputs.tests_exist == 'false'
        run: |
          echo "‚ÑπÔ∏è  Skipping test execution"
          echo "Reason: No tests directory or test files found in repository"
          echo ""
          echo "This is expected behavior when:"
          echo "  - Repository is newly created"
          echo "  - Tests haven't been synced yet"
          echo "  - Tests are in a different location"
          echo ""
          echo "Status: ‚úÖ Workflow completed successfully (tests skipped)"
          exit 0
  
  test-combined:
    name: test
    needs: test
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.test.result }}" == "success" ] || [ "${{ needs.test.result }}" == "skipped" ]; then
            echo "‚úÖ All test jobs completed successfully"
            exit 0
          else
            echo "‚ùå Test jobs failed"
            exit 1
          fi

